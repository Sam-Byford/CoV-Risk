<div class="container HRA-container margin-b5">
  <div class="row page-title">
    <div class="col d-flex justify-content-center">
      <h1 class="display-3 pageTitle">High Risk Analysis</h1>
    </div>
  </div>
  <div class="d-flex justify-content-center">
    <div class="subheading" style="margin-top:1%; margin-bottom:1%;">
      The Cov-Risk algorithm analyses patients pre-conditions to determine vaccination prioritisation. To do this, a file of patient medical data must be uploaded below.
    </div>
  </div>
  <div class="d-flex justify-content-center">
    <div class="subheading" style="margin-top:0;">
      First Time here? View our
      <span (click)="AboutRoute();" style="text-decoration:underline; cursor:pointer;">How To Guides</span>
      for help.
    </div>
  </div>
  <div class="row upload-row mobile-upload-row">
    <div class="col upload-button-mobile">
      <div class="overlay">
        <input type="file" #file placeholder="Choose file" (change)="openDialog(file)" style="display:none;" />
        <button id="HRA-btns" class="btn btn-primary btn-lg" (click)="file.click()">Upload File</button>
      </div>
    </div>
  </div>
  <div class="row upload-row">
    <div class="col-3 upload-button-desktop">
      <div class="overlay">
        <input type="file" #file placeholder="Choose file" (change)="openDialog(file)" style="display:none;" /><!--"Upload(file)"-->
        <button id="HRA-btns" class="btn btn-primary btn-lg" (click)="file.click()">Upload File</button>
      </div>
    </div>
    <div class="col-9 d-flex justify-content-center full-width-column">
      <p id="HRA-text">
        To upload a file, click on the 'Upload' button on the left. The algorithm will extract patient data from the file and generate a risk score for each patient. This score signifies how likely each patients is
        to expereince a severe case of Covid-19. The higher the score, the higher the risk.<strong> A score equal to, or greater than, 50 means the patient is high risk.</strong>
        <br />
        <br />
        The risk score is generated by analysing what conditions a patient has. Each condition is worth a certain number of points, the cumulative sum of these points gives the patient's Risk Score.
        For a detailed explanation on how the algorithm works, view the
        <span style="text-decoration:underline; cursor:pointer; font-weight:bold;" (click)="AboutRoute();">About</span> page.
        <br />
        <br />
        The results of the <em>current</em> upload will be viewable in a table below. <em>All</em> of the patient results can then be found on the
        <span (click)="ResultsRoute();" style="text-decoration:underline; cursor:pointer; font-weight:bold;">Results</span> page.
        <br />
        <br />
        The file should be a '.csv' in the format shown in the template. Need a Template? <span (click)="ToggleTemplate();" style="text-decoration:underline; cursor:pointer; font-weight:bold;">Click here</span>
      </p>
    </div>
  </div>
  <div class="row download-row mobile-download-row" [ngClass]="{'shownMobile': showMore, 'hiddenMobile': !showMore}">
    <div class="col download-button-mobile">
      <div class="overlay">
        <button id="HRA-btns" class="btn btn-primary btn-lg" (click)="Download()">Download Template</button>
      </div>
    </div>
  </div>
  <div class="row download-row" [ngClass]="{'shown': showMore, 'hidden': !showMore}">
    <div class="col-9 d-flex justify-content-center full-width-column">
      <p id="HRA-download-text">
        Click the 'Download Template' button to download a template. If you are stuck, or if this is your first time here, view the
        <span style="text-decoration:underline; cursor:pointer; font-weight:bold;" (click)="AboutRoute();">Creating And Uploading A File</span> guide.
        <br />
        <br />
        Acceptable values for each feild in the template file are listed below:
        <br />
        * ID - Patient specific ID, can be a serious of numbers, letters or both. ID Should have no spaces
        <br />
        * Sex - Sex of patient, can be M (male) or F (female)
        <br />
        * Age - Age of patient, number in range 0-120
        <br />
        * Preconditions - Existing conditions the patient has, can be one or multiple of the following: 'COPD', 'pneumonia', 'renal_chronic', 'diabetes', 'hypertension', 'obesity', 'immunosuppressed'.
        Can be left blank if patient has no existing conditions
        <br />
        * Phone Number - Mobile number of the user, must be a valid mobile number with country code. Can be left blank
        <br />
        <br />
        <span style="text-decoration:underline; cursor:pointer; text-align:right; font-weight:bold;" (click)="ToggleTemplate();">Show Less</span>
      </p>
    </div>
    <div class="col-3 download-button">
      <div class="overlay">
        <button id="HRA-btns" class="btn btn-primary btn-lg" (click)="Download()">Download Template</button>
      </div>
    </div>
  </div>
  <div class="float-right HRAFilter" [hidden]="patientResponse.patients.length == 0">
    <button class="btn btn-primary aboutRouteBtn" (click)="ResultsRoute()">
      View All Results
      <fa-icon [icon]="appService.faArrowRight"></fa-icon>
    </button>
  </div>
  <mat-form-field [hidden]="patientResponse.patients.length == 0">
    <mat-label>Filter</mat-label>
    <input matInput (keyup)="applyHRAFilter($event)" placeholder="Filter By Any Column" #input />
  </mat-form-field>
  <div [hidden]="patientResponse.patients.length == 0" class="mat-elevation-z4 responseTable">
    <table mat-table [dataSource]="HRADataSource" style="width:inherit; border-collapse:separate;" matSort>
      <ng-container matColumnDef="id" sticky>
        <th mat-header-cell *matHeaderCellDef class="table-head" mat-sort-header> ID </th>
        <td mat-cell *matCellDef="let patient" [style.color]="patient.rowColour"> {{patient.id}} </td>
      </ng-container>
      <ng-container matColumnDef="sex">
        <th mat-header-cell *matHeaderCellDef class="table-head" mat-sort-header> Sex </th>
        <td mat-cell *matCellDef="let patient" [style.color]="patient.rowColour"> {{patient.sex}} </td>
      </ng-container>
      <ng-container matColumnDef="age">
        <th mat-header-cell *matHeaderCellDef class="table-head" mat-sort-header> Age </th>
        <td mat-cell *matCellDef="let patient" [style.color]="patient.rowColour"> {{patient.age}} </td>
      </ng-container>
      <ng-container matColumnDef="preconditions">
        <th mat-header-cell *matHeaderCellDef class="table-head" mat-sort-header> Preconditions </th>
        <td mat-cell *matCellDef="let patient" [style.color]="patient.rowColour"> {{patient.preconditions.length > 0 ? patient.preconditions : '--'}} </td>
      </ng-container>
      <ng-container matColumnDef="riskScore">
        <th mat-header-cell *matHeaderCellDef class="table-head" mat-sort-header> Risk Score </th>
        <td mat-cell *matCellDef="let patient" [style.color]="patient.rowColour"> {{patient.riskScore}} </td>
      </ng-container>
      <ng-container matColumnDef="highRisk">
        <th mat-header-cell *matHeaderCellDef class="table-head" mat-sort-header> High Risk </th>
        <td mat-cell *matCellDef="let patient" [style.color]="patient.rowColour"> {{patient.highRisk.toString().toUpperCase()}} </td>
      </ng-container>
      <tr mat-header-row *matHeaderRowDef="columnsToDisplay"></tr>
      <tr mat-row *matRowDef="let myRowData; columns: columnsToDisplay"></tr>

      <!-- Row shown when there is no matching data. -->
      <tr class="mat-row" *matNoDataRow>
        <td class="mat-cell" colspan="4">No data matching the filter "{{input.value}}"</td>
      </tr>
    </table>
  </div>
  <mat-paginator class="paginator table-head" [pageSizeOptions]="[8]" showFirstLastButtons [hidden]="patientResponse.patients.length == 0"></mat-paginator>
  <div #spinner class="spinner-container">
    <mat-spinner id="loading-spinner" [ngClass]="{'spinner-shown': this.loading, 'spinner-hidden': !this.loading}" [strokeWidth]=5 [diameter]=60></mat-spinner>
  </div>
</div>
